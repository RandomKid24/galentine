# Seat Management System - Implementation Guide

## Overview

The Galentine's event now has a sophisticated seat management system with two separate seat pools:

### Seat Pools

1. **Early Bird Pool**: 15 dedicated seats for early bird passes
2. **General Pool**: 15 shared seats for all other passes

## How It Works

### For Early Bird Passes

- When you create a pass and check "Early Bird Pass", it uses the dedicated early bird pool
- If someone books an Early Bird pass (even if it's for 3 people), it deducts from the 15 early bird seats
- Example: Early Bird Trio (3 people) → Early bird seats: 15 - 3 = 12 remaining

### For General Passes

- All non-early-bird passes share the general pool of 15 seats
- Each booking reduces seats by the `max_people` value
- Example: Trio Pass (3 people) → General seats: 15 - 3 = 12 remaining
- Example: Duo Pass (2 people) → General seats: 12 - 2 = 10 remaining

## Database Setup

### Step 1: Run the SQL Migration

Go to your Supabase Dashboard → SQL Editor and run:

```sql
-- Create seat configuration table
CREATE TABLE IF NOT EXISTS public.seat_config (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    config_key TEXT UNIQUE NOT NULL,
    total_seats INTEGER NOT NULL DEFAULT 0,
    used_seats INTEGER NOT NULL DEFAULT 0,
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Insert default seat configuration
INSERT INTO public.seat_config (config_key, total_seats, used_seats)
VALUES
    ('early_bird', 15, 0),
    ('general', 15, 0)
ON CONFLICT (config_key) DO NOTHING;

-- RLS for seat_config table
ALTER TABLE public.seat_config ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Enable read seat_config for everyone" ON public.seat_config
    FOR SELECT USING (true);

CREATE POLICY "Enable update seat_config for authenticated users" ON public.seat_config
    FOR UPDATE USING (true);

-- Add is_early_bird flag to passes table
ALTER TABLE public.passes ADD COLUMN IF NOT EXISTS is_early_bird BOOLEAN DEFAULT false;
```

### Step 2: Create Passes in Admin

1. Go to `/admin/passes`
2. Click "Add Pass"
3. Fill in the details:
   - **Title**: e.g., "Early Bird Pass"
   - **Price**: e.g., 249
   - **Total Seats**: 0 (not used for seat tracking, managed by seat_config)
   - **Max People**: 1 (or 2, 3, etc.)
   - **Check "Early Bird Pass"** if it should use the early bird pool
   - Upload QR code for payment
4. Save

## Features

### Frontend (`/`)

- **Seat Availability Display**: Shows remaining seats for both pools
- **Auto-disable Sold Out Passes**: Passes are automatically disabled when not enough seats are available
- **Real-time Updates**: Seat counts are fetched on page load
- **Payment QR Code**: Displays the QR code for the selected pass

### Admin (`/admin/passes`)

- **Pass Management**: Full CRUD for passes
- **Early Bird Toggle**: Checkbox to mark a pass as early bird
- **QR Code Upload**: Upload payment QR codes as base64
- **UPI ID**: Store UPI ID for manual payments

### API (`/api/register`)

- **Seat Validation**: Checks seat availability before registration
- **Automatic Seat Deduction**: Updates seat counts after successful registration
- **Error Handling**: Returns clear error messages when seats are full

## Example Scenarios

### Scenario 1: Early Bird Bookings

```
Initial State:
- Early Bird: 15/15 available
- General: 15/15 available

User 1 books: Early Bird Pass (1 person)
- Early Bird: 14/15 available
- General: 15/15 available

User 2 books: Early Bird Trio (3 people)
- Early Bird: 11/15 available
- General: 15/15 available
```

### Scenario 2: General Bookings

```
Initial State:
- Early Bird: 15/15 available
- General: 15/15 available

User 1 books: Regular Pass (1 person)
- Early Bird: 15/15 available
- General: 14/15 available

User 2 books: Duo Pass (2 people)
- Early Bird: 15/15 available
- General: 12/15 available

User 3 books: Trio Pass (3 people)
- Early Bird: 15/15 available
- General: 9/15 available
```

### Scenario 3: Mixed Bookings

```
Initial State:
- Early Bird: 15/15 available
- General: 15/15 available

User 1 books: Early Bird Pass (1 person)
- Early Bird: 14/15 available
- General: 15/15 available

User 2 books: Regular Pass (1 person)
- Early Bird: 14/15 available
- General: 14/15 available

User 3 books: Trio Pass (3 people)
- Early Bird: 14/15 available
- General: 11/15 available
```

## Adjusting Seat Limits

To change the total seats available:

1. Go to Supabase Dashboard → Table Editor
2. Open the `seat_config` table
3. Edit the `total_seats` value for either:
   - `early_bird` (currently 15)
   - `general` (currently 15)
4. Save

The frontend will automatically reflect the new limits on next page load.

## Monitoring Seat Usage

### Via Supabase Dashboard

1. Go to Table Editor
2. Open `seat_config` table
3. View `used_seats` and `total_seats` for each pool

### Via Admin Dashboard (Future Enhancement)

You could add a dashboard widget showing:

- Current seat availability
- Recent registrations
- Seat usage trends

## Troubleshooting

### Seats not updating after registration

- Check the browser console for errors
- Verify the `seat_config` table exists
- Check RLS policies are set correctly

### Passes showing as sold out when they shouldn't be

- Refresh the page to get latest seat counts
- Check `seat_config` table for correct `used_seats` values
- Verify `is_early_bird` flag is set correctly on passes

### Registration failing with "not enough seats"

- This is working correctly - the pass requires more seats than available
- Check seat availability display on frontend
- Adjust seat limits if needed

## Summary

Your seat management system is now fully functional with:
✅ Separate early bird and general seat pools
✅ Automatic seat deduction on registration
✅ Real-time seat availability display
✅ Sold-out pass detection and disabling
✅ Payment QR code display per pass
✅ Admin interface for pass management

The system ensures fair seat allocation and prevents overbooking!
